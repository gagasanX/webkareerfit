// =================================================================
// PRISMA SCHEMA – COMPLETE & FINAL
// =================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =================================================================
// USERS & ROLES
// =================================================================
model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String                 @unique
  password              String
  image                 String?
  bio                   String?
  skills                String?
  education             String?
  experience            String?
  phone                 String?
  role                  String                 @default("USER")
  isAdmin               Boolean                @default(false)
  isAffiliate           Boolean                @default(false)
  isClerk               Boolean                @default(false)
  affiliateCode         String?                @unique
  affiliateType         String?                @default("individual")
  referredBy            String?                // affiliate code who referred this user
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  // relations
  affiliateApplications AffiliateApplication[]
  affiliateStats        AffiliateStats?
  AffiliateTransaction  AffiliateTransaction[]
  assessments           Assessment[]
  assignedAssessments   Assessment[]           @relation("ClerkAssessments")
  payments              Payment[]
  referrals             Referral[]
}

// =================================================================
// ASSESSMENTS (career tests)
// =================================================================
model Assessment {
  id               String     @id @default(cuid())
  type             String     // ccrl, cdrl, ctrl, etc.
  tier             String     @default("basic")
  status           String     @default("pending")
  data             Json?
  price            Float
  manualProcessing Boolean    @default(false)
  reviewNotes      String?
  reviewedAt       DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  userId          String
  assignedClerkId String?

  user          User           @relation(fields: [userId], references: [id])
  assignedClerk User?          @relation("ClerkAssessments", fields: [assignedClerkId], references: [id])
  payment       Payment?
  referrals     Referral[]

  @@index([userId])
  @@index([assignedClerkId])
  @@index([status])
}

// =================================================================
// PAYMENTS & COUPONS
// =================================================================
model Payment {
  id                   String                 @id @default(cuid())
  amount               Float
  method               String
  status               String                 @default("pending")
  gatewayPaymentId     String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  userId               String
  assessmentId         String                 @unique
  couponId             String?

  // ✅ add the back-relation
  referrals            Referral[]

  assessment           Assessment             @relation(fields: [assessmentId], references: [id])
  coupon               Coupon?                @relation(fields: [couponId], references: [id])
  user                 User                   @relation(fields: [userId], references: [id])
  AffiliateTransaction AffiliateTransaction[]
}

model Coupon {
  id                 String    @id @default(cuid())
  code               String    @unique
  discountPercentage Float     @default(0)
  maxDiscount        Float?
  expiresAt          DateTime
  maxUses            Int       @default(100)
  currentUses        Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  payments           Payment[]
}

// =================================================================
// AFFILIATE SYSTEM
// =================================================================
model AffiliateStats {
  id             String   @id @default(cuid())
  totalReferrals Int      @default(0)
  totalEarnings  Float    @default(0)
  totalPaid      Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
}

model Referral {
  id             String      @id @default(cuid())
  userName       String?
  email          String?
  assessmentId   String?
  assessmentType String?
  status         String
  commission     Float       @default(0)
  paidOut        Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  affiliateId String
  paymentId   String?   // <-- NEW: resolves webhook build error

  affiliate  User        @relation(fields: [affiliateId], references: [id])
  assessment Assessment? @relation(fields: [assessmentId], references: [id])
  payment    Payment?    @relation(fields: [paymentId], references: [id])

  @@index([affiliateId])
  @@index([assessmentId])
  @@index([paymentId])
}

model AffiliateApplication {
  id          String   @id @default(cuid())
  fullName    String
  email       String
  phone       String
  website     String?
  socialMedia String?
  howPromote  String
  status      String   @default("pending")
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AffiliateTransaction {
  id        String    @id @default(cuid())
  amount    Float
  status    String    @default("pending")
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  userId    String
  paymentId String

  user    User    @relation(fields: [userId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])
}

// =================================================================
// CAREER SUGGESTER (lead-gen)
// =================================================================
model CareerSuggestion {
  id               String  @id @default(cuid()) @db.VarChar(255)
  superpowercode   String? @db.VarChar(10)
  jobtitle         String? @db.VarChar(255)
  shortdescription String?
  level            String? @default("mid") @db.VarChar(10)

  @@index([superpowercode, level])
}

model FreeSuggestionSubmission {
  id             String    @id @default(cuid()) @db.VarChar(255)
  email          String?   @db.VarChar(255)
  userip         String?   @db.VarChar(255)
  createdat      DateTime? @default(now()) @db.Timestamp(6)
  usertype       String?   @db.VarChar(20)
  userinput      String?   @db.VarChar(255)
  superpowercode String?   @db.VarChar(10)
}

// =================================================================
// AUDIT LOG (used by admin routes)
// =================================================================
model AuditLog {
  id        String   @id @default(cuid())
  eventType String
  userId    String?
  details   Json
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
}

// =================================================================
// SYSTEM CONFIGS
// =================================================================
model SystemSetting {
  key       String   @id
  value     String
  isJson    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}